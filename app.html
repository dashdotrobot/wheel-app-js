<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

  <title>Hello, world!</title>
</head>
<body>

<div class="container">
  <h3>Bicycle wheel app</h3>
  <div class="row">
    <div class="col-sm-4">

      <!-- Toolbar Navigation Tabs -->
      <ul class="nav nav-tabs" id="toolsTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="tabRim" data-toggle="tab" href="#panelRim" role="tab" aria-controls="panelRim" aria-selected="true">Rim</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tabHub" data-toggle="tab" href="#panelHub" role="tab" aria-controls="panelHub" aria-selected="false">Hub</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tabSpokes" data-toggle="tab" href="#panelSpokes" role="tab" aria-controls="panelSpokes" aria-selected="false">Spokes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tabForces" data-toggle="tab" href="#panelForces" role="tab" aria-controls="panelForces" aria-selected="false">Forces</a>
        </li>
      </ul>

      <div class="tab-content" id="toolsContents">

        <!-- RIM TOOLBAR -->
        <div class="tab-pane fade show active" id="panelRim" role="tabpanel" aria-labelledby="tabRim">

          <form id="formRim">

            <div class="form-group">
              <select class="form-control form-control-sm" name="rimSize" id="rimSize">
                <option>700C/29er/28" (622)</option>
                <option>27" frac (630)</option>
                <option>650B (584)</option>
              </select>
            </div>

            <div class="form-group">
              <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons" id="rimMatl">
                <label class="btn btn-secondary active">
                  <input type="radio" name="rimMatl" value="Alloy" id="rimMatlAlloy" autocomplete="off" checked>Alloy
                </label>
                <label class="btn btn-secondary">
                  <input type="radio" name="rimMatl" value="Steel" id="rimMatlSteel" autocomplete="off">Steel
                </label>
                <!-- <label class="btn btn-secondary"> -->
                  <!-- <input type="radio" name="rimMatl" value="carbon" id="rimMatlCarbon" autocomplete="off">Carbon -->
                <!-- </label> -->
              </div>
            </div>

            <div class="form-group">
              <label for="rimMass">Mass [grams]:&nbsp;</label><span><strong>540</strong></span>
              <input type="range" class="form-control-range custom-range update-range" name="rimMass" id="rimMass" min="10" step="10" max="2000" value="540">

              <label for="rimRadStiff">Radial stiffness [N-m^2]:&nbsp;</label><span><strong>110</strong></span>
              <input type="range" class="form-control-range custom-range update-range" name="rimRadStiff" id="rimRadStiff" min="10" max="1000" step="10" value="110">

              <label for="rimLatStiff">Lateral stiffness [N-m^2]:&nbsp;</label><span><strong>220</strong></span>
              <input type="range" class="form-control-range custom-range update-range" name="rimLatStiff" id="rimLatStiff" min="10" max="500" value="220">

              <label for="rimTorStiff">Torsional stiffness [N-m<sup>2</sup>]:&nbsp;</label><span><strong>25</strong></span>
              <input type="range" class="form-control-range custom-range update-range" name="rimTorStiff" id="rimTorStiff" min="5" max="200" step="5" value="25">
            </div>

          </form>

        </div>

        <!-- HUB TOOLBAR -->
        <div class="tab-pane fade" id="panelHub" role="tabpanel" aria-labelledby="tabHub">

          <form id="formHub">

            <div class="form-group">
              <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons" id="hubSymm">
                <label class="btn btn-secondary active">
                  <input type="radio" id="rimMatlAlloy" autocomplete="off" checked>Symmetric
                </label>
                <label class="btn btn-secondary">
                  <input type="radio" id="rimMatlSteel" autocomplete="off">Asymmetric
                </label>
              </div>
            </div>

            <label for="hubWidthLeft">Rim-to-flange distance [mm]</label>

            <div class="form-row">
              <div class="col-sm-6">
                Left:&nbsp;<span id="hubWidthLeft_label"><strong>25</strong></span>
              </div>
              <div class="col-sm-6">
                Right:&nbsp;<span id="hubWidthRight_label"><strong>25</strong></span>
              </div>
            </div>

            <div class="form-group form-row">
              <div class="col-sm-6">
                <input type="range" class="form-control-range custom-range" name="hubWidthLeft" id="hubWidthLeft" min="-50" max="0" step="1" value="-25">
              </div>
              <div class="col-sm-6">
                <input type="range" class="form-control-range custom-range" name="hubWidthRight" id="hubWidthRight" min="0" max="50" step="1" value="25">
              </div>
            </div>

            <div class="form-group">
              <label for="hubDiameter">Flange diameter [mm]:&nbsp;</label><span><strong>50</strong></span>
              <input type="range" class="form-control-range custom-range update-range" name="hubDiameter" id="hubDiameter" min="0" max="100" value="50">
            </div>

          </form>

        </div>

        <!-- SPOKES TOOLBAR -->
        <div class="tab-pane fade" id="panelSpokes" role="tabpanel" aria-labelledby="tabSpokes">

          <div class="form-group">
            <label for="spkNum">Number of spokes:&nbsp;</label><span><strong>36</strong></span>
            <input type="range" class="form-control-range custom-range update-range" name="spkNum" id="spkNum" min="4" max="64" step="2" value="36">
          </div>

          <hr/><strong>Drive-side spokes</strong>

          <form id="formSpokesDS">
            <div class="form-group">
              <select class="form-control form-control-sm" name="spkPattern" id="spkPatternDS">
                <option>Radial</option>
                <option>1-cross</option>
                <option>2-cross</option>
                <option selected>3-cross</option>
                <option>4-cross</option>
              </select>
            </div>

            <div class="form-group">
              <div class="btn-group btn-group-sm btn-group-toggle" data-toggle="buttons" id="spkMatlDS">
                <label class="btn btn-secondary active">
                  <input type="radio" name="spkMatl" value="Steel" id="spkMatlDSSteel" autocomplete="off" checked>Steel
                </label>
                <label class="btn btn-secondary">
                  <input type="radio" name="spkMatl" value="Alloy" id="spkMatlDSAlloy" autocomplete="off">Alloy
                </label>
                <label class="btn btn-secondary">
                  <input type="radio" name="spkMatl" value="Titanium" id="spkMatlDSTi" autocomplete="off">Titanium
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="spkDiamDS">Diameter [mm]:&nbsp;</label><span><strong>2</strong></span>
              <input type="range" class="form-control-range custom-range update-range" name="spkDiam" id="spkDiamDS" min="0.1", max="3" step="0.1" value="2">

              <label for="spkTensDS">Tension [kgf]:&nbsp;</label><span><strong>80</strong></span>
              <input type="range" class="form-control-range custom-range update-range" name="spkTens" id="spkTensDS" min="0" max="200" step="5" value="80">
            </div>
          </form>

          <hr/><strong>Non-drive-side spokes</strong>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="spkNDSSame" checked>
            <label class="form-check-label" for="spkNDSSame">Same as drive-side</label>
          </div>

          <div class="collapse" id="spkNDSPanel">

            <form id="formSpokesNDS">
              <div class="form-group">
                <select class="form-control form-control-sm" name="spkPattern" id="spkPattern">
                  <option>Radial</option>
                  <option>1-cross</option>
                  <option>2-cross</option>
                  <option selected>3-cross</option>
                  <option>4-cross</option>
                </select>
              </div>

              <div class="form-group">
                <div class="btn-group btn-group-toggle btn-group-sm" data-toggle="buttons" id="spkMatlNDS">
                  <label class="btn btn-secondary active">
                    <input type="radio" name="spkMatl" value="Steel" id="spkMatlNDSSteel" autocomplete="off" checked>Steel
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="spkMatl" value="Alloy" id="spkMatlNDSAlloy" autocomplete="off">Alloy
                  </label>
                  <label class="btn btn-secondary">
                    <input type="radio" name="spkMatl" value="Titanium" id="spkMatlNDSTi" autocomplete="off">Titanium
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label for="spkDiamNDS">Diameter [mm]&nbsp;</label><span><strong>2</strong></span>
                <input type="range" class="form-control-range custom-range update-range" name="spkDiam" id="spkDiamNDS" min="0.1", max="3" step="0.1" value="2">

                <label for="spkTensNDS">Tension [kgf]:&nbsp;</label><span><strong>80</strong></span>
                <input type="range" class="form-control-range custom-range update-range" name="spkTens" id="spkTensNDS" min="0" max="200" step="5" value="80">
              </div>
            </form>

          </div>

        </div>

        <!-- FORCES TOOLBAR -->
        <div class="tab-pane fade show" id="panelForces" role="tabpanel" aria-labelledby="tabForces">

          <table class="table table-striped table-hover table-sm" id="tableForces">
            <tr><th>Type</th><th>Location [deg]</th><th>Magnitude [kgf]</th><th></th></tr>
            <tr><th>Radial</th><td>0</td><td>50</td><th><i class="fas fa-trash-alt"></i></th></tr>
          </table>

          <button type="button" class="btn btn-sm">Radial</button>
          <button type="button" class="btn btn-sm">Lateral</button>
          <button type="button" class="btn btn-sm">Tangential</button>
        </div>

        <div><button type="button" id="btnPressMe" class="btn btn-success">Press me!</button></div>
      </div>

    </div>
    <div class="col-sm-8">

      <!-- Results navigation tabs -->
      <ul class="nav nav-tabs" id="resultsTab" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="plots-tab" data-toggle="tab" href="#plots" role="tab" aria-controls="plots" aria-selected="true">Plots</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="results-tab" data-toggle="tab" href="#results" role="tab" aria-controls="results" aria-selected="false">Results</a>
        </li>
      </ul>

      <div class="tab-content" id="resultsContents">

        <!-- Results: Plots -->
        <div class="tab-pane fade show active" id="plots" role="tabpanel" aria-labelledby="plots-tab">
          <div id="tension-plot" style="height: 300px; width: 100%; border: 1px solid black;"></div>
        </div>

        <!-- Results: Summary -->
        <div class="tab-pane fade" id="results" role="tabpanel" aria-labelledby="results-tab">Summary results</div>
      </div>
    </div>

  </div>
</div>


<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script src="mindmup-editabletable.js"></script>

<script>

/* -------------------------------- CONSTANTS -------------------------------- **
**
** --------------------------------------------------------------------------- */

var rimMaterials = {
  'Alloy': {
    'density': 2700,
    'young_mod': 69e9,
    'shear_mod': 26e9
  },
  'Steel': {
    'density': 8000,
    'young_mod': 200e9,
    'shear_mod': 77e9
  }
}

var spkMaterials = {
  'Alloy': {
    'density': 2700,
    'young_mod': 69e9,
  },
  'Steel': {
    'density': 8000,
    'young_mod': 210e9,
  },
  'Titanium': {
    'density': 4500,
    'young_mod': 105e9
  }
}

var default_wheel = {
  'wheel': {
    'hub': {
      'diameter': 0.05,
      'width_nds': 0.025,
      'width_ds': 0.025},
    'rim': {
      'radius': 0.3,
      'young_mod': 69e9,
      'shear_mod': 26e9,
      'density': 2700.,
      'section_type': 'general',
      'section_params': {
        'area': 100e-6,
        'I_rad': 100 / 69e9,
        'I_lat': 200 / 69e9,
        'J_tor': 25 / 26e9,
        'I_warp': 0.}},
    'spokes': {
      'num': 36,
      'num_cross': 3,
      'diameter': 1.8e-3,
      'young_mod': 210e9,
      'density': 8000.,
      'offset': 0.,
      'tension': 0.}},
}


/* -------------------------------- CALLBACKS -------------------------------- **
**
** --------------------------------------------------------------------------- */

// Update value labels for all range sliders with class .update-range
$('input.update-range').on('change mousemove', function() {
  $(this).prev().html('<strong>' + $(this).val() + '</strong>');
})

// Update value labels for hub width range sliders
$('#hubWidthLeft').on('change mousemove', function() {
  $(('#hubWidthLeft_label')).html('<strong>' + (-parseInt($(this).val())).toString() + '</strong>')

  // If symmetric, update the other one to match
  // TODO

})

$('#hubWidthRight').on('change mousemove', function() {
  $(('#hubWidthRight_label')).html('<strong>' + $(this).val() + '</strong>')

  // If symmetric, update the other one to match
  // TODO

})

// Show or hide the non-drive-side spoke panel
$('#spkNDSSame').click(function() {
  if ($('#spkNDSSame').is(':checked')) {
    $('#spkNDSPanel').collapse('hide')
  } else {
    $('#spkNDSPanel').collapse('show')
  }
})



$('#tableForces').editableTableWidget();
// $('.editable-row').editableTableWidget();



// Work the magic!
$('#btnPressMe').on('click', function () {

  post_data = {'wheel': {}}
  post_data['wheel']['rim'] = build_json_rim()
  post_data['wheel']['hub'] = build_json_hub()

  if ($('#spkNDSSame').is(':checked')) {

    spkJSON = build_json_spokes($('#formSpokesDS'))
    spkJSON['num'] = parseInt($('#spkNum').val())

    post_data['wheel']['spokes'] = spkJSON

  } else {

    dsJSON = build_json_spokes($('#formSpokesDS'))
    ndsJSON = build_json_spokes($('#formSpokesNDS'))

    dsJSON['num'] = parseInt($('#spkNum').val())/2
    ndsJSON['num'] = parseInt($('#spkNum').val())/2

    post_data['wheel']['spokes_ds'] = dsJSON
    post_data['wheel']['spokes_nds'] = ndsJSON

  }

  post_data['tension'] = {
    'forces': [{'location': 3.1415, 'magnitude': [0., 1., 0., 0.]}]
  }

  console.log(post_data)

  $.post({
    url: 'http://localhost:5000/calculate',
    data: JSON.stringify(post_data),
    dataType: 'json',
    contentType: 'application/json',
    success: function (result) {
      plot_tensions(result);
    },
    error: function (xhr, ajaxOptions, thrownError) {}
  });

})


/* -------------------------------- FUNCTIONS -------------------------------- **
**
** --------------------------------------------------------------------------- */

// Build JSON request object to send to wheel-api
function build_json_rim() {

  var rimForm = {}
  var rimJSON = {}

  // Load form data
  $('#formRim').serializeArray().forEach(e => { rimForm[e['name']] = e['value']; })

  // ISO diameter
  rimJSON['radius'] = 0.001*(parseFloat(/\((\d+)\)/g.exec(rimForm['rimSize'])[1])/2 - 5)

  // Material
  rimJSON['density'] = rimMaterials[rimForm['rimMatl']]['density']
  rimJSON['young_mod'] = rimMaterials[rimForm['rimMatl']]['young_mod']
  rimJSON['shear_mod'] = rimMaterials[rimForm['rimMatl']]['shear_mod']

  // Section properties
  rimJSON['section_type'] = 'general'
  rimJSON['section_params'] = {
    'area': 0.001*parseFloat(rimForm['rimMass']) / (rimJSON['density'] * 2*3.1415*rimJSON['radius']),
    'I_rad': parseFloat(rimForm['rimRadStiff']) / rimJSON['young_mod'],
    'I_lat': parseFloat(rimForm['rimLatStiff']) / rimJSON['young_mod'],
    'J_tor': parseFloat(rimForm['rimTorStiff']) / rimJSON['shear_mod'],
    'I_warp': 0.
  }

  return rimJSON
}

function build_json_hub() {

  var form = {}
  var json = {}

  // Load form data
  $('#formHub').serializeArray().forEach(e => { form[e['name']] = e['value']; })

  json['diameter'] = 0.001*parseFloat(form['hubDiameter'])
  json['width_ds'] = 0.001*parseFloat(form['hubWidthRight'])
  json['width_nds'] = -0.001*parseFloat(form['hubWidthLeft'])

  return json
}

function build_json_spokes(form_obj) {

  var form = {}
  var json = {}

  // Load form data
  form_obj.serializeArray().forEach(e => { form[e['name']] = e['value']; })

  // Pattern
  if (form['spkPattern'] == 'Radial') {
    json['num_cross'] = 0
  } else {
    json['num_cross'] = parseInt(form['spkPattern'].substring(0, 1))
  }

  // Material
  json['density'] = spkMaterials[form['spkMatl']]['density']
  json['young_mod'] = spkMaterials[form['spkMatl']]['young_mod']

  json['diameter'] = 0.001*parseFloat(form['spkDiam'])
  json['offset'] = 0.
  json['tension'] = parseFloat(form['spkTens']) * 9.81  // Newtons (from kgf)

  return json
}


function plot_tensions(data) {
  console.log(data)

  plot_canvas = document.getElementById('tension-plot');

  Plotly.newPlot(plot_canvas, [{
    x: data['tension']['spokes'],
    y: data['tension']['d_tension'],
    type: 'bar'
  }] );
}


TESTER = document.getElementById('tension-plot');
Plotly.plot(TESTER,
[{
  x: [1, 3, 5],
  y: [2, 5, 3],
  type: 'bar'
}, {
  x: [0, 2, 4],
  y: [4, 4, 1],
  type: 'bar'
}] , {responsive: true});


</script>

</body>
</html>